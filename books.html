<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple HTML Page</title>
</head>
<body>
    <header>
        <h1>Welcome to My Page</h1>
    </header>
    
    <nav>
        <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
        </ul>
    </nav>

    <main>
        <section id="home">
            <h2>Home Section</h2>
            <p>This is the home section of the website.</p>
        </section>

        <section id="about">
            <h2>About Section</h2>
            <p>Here you can learn more about this website and its purpose.</p>
        </section>

        <section id="contact">
            <h2>Contact Section</h2>
            <p>If you'd like to get in touch, please use the contact information provided.</p>
        </section>

        <section id="search-and-filter">
            <h2>Book Search and Filter</h2>
            <input type="text" id="searchInput" placeholder="Search for books...">
            <div>
                <label for="ageRangeMin">Age Min:</label>
                <input type="number" id="ageRangeMin" value="10" min="10" max="18">
                <label for="ageRangeMax">Age Max:</label>
                <input type="number" id="ageRangeMax" value="18" min="10" max="18">
            </div>
            <div>
                <label for="priceRangeMin">Price Min:</label>
                <input type="number" id="priceRangeMin" value="250" min="250" max="50000" step="250">
                <label for="priceRangeMax">Price Max:</label>
                <input type="number" id="priceRangeMax" value="50000" min="250" max="50000" step="250">
            </div>
            <div id="booksContainer"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 My Simple Page. All rights reserved.</p>
    </footer>

    <script>
        // Constants for filter defaults and validation
        const FILTER_DEFAULTS = {
            AGE: {
                MIN: 10,
                MAX: 18
            },
            PRICE: {
                MIN: 250,
                MAX: 50000,
                STEP: 250
            }
        };

        class BookSearchAndFilter {
            constructor() {
                this.allBooks = [];
                this.filteredBooks = [];
                this.currentFilters = {
                    age: { min: FILTER_DEFAULTS.AGE.MIN, max: FILTER_DEFAULTS.AGE.MAX },
                    price: { min: FILTER_DEFAULTS.PRICE.MIN, max: FILTER_DEFAULTS.PRICE.MAX }
                };
                this.searchTerm = '';
                
                this.initializeListeners();
            }

            initializeListeners() {
                // Debounced search input handler
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('input', this.debounce(() => {
                    this.searchTerm = this.sanitizeInput(searchInput.value);
                    this.applyFiltersAndSearch();
                }, 300));

                // Filter input handlers
                ['ageRangeMin', 'ageRangeMax', 'priceRangeMin', 'priceRangeMax'].forEach(id => {
                    const element = document.getElementById(id);
                    element.addEventListener('change', () => {
                        this.validateAndUpdateFilters();
                        this.applyFiltersAndSearch();
                    });
                });
            }

            sanitizeInput(input) {
                // Remove any potentially harmful characters
                return input.replace(/[<>{}]/g, '').toLowerCase().trim();
            }

            validateAndUpdateFilters() {
                // Age validation
                let ageMin = parseInt(document.getElementById('ageRangeMin').value);
                let ageMax = parseInt(document.getElementById('ageRangeMax').value);
                
                // Ensure values are within valid range
                ageMin = this.clamp(ageMin, FILTER_DEFAULTS.AGE.MIN, FILTER_DEFAULTS.AGE.MAX);
                ageMax = this.clamp(ageMax, FILTER_DEFAULTS.AGE.MIN, FILTER_DEFAULTS.AGE.MAX);
                
                // Ensure min doesn't exceed max
                if (ageMin > ageMax) {
                    [ageMin, ageMax] = [ageMax, ageMin];
                }

                // Price validation
                let priceMin = parseInt(document.getElementById('priceRangeMin').value);
                let priceMax = parseInt(document.getElementById('priceRangeMax').value);
                
                // Ensure values are within valid range
                priceMin = this.clamp(priceMin, FILTER_DEFAULTS.PRICE.MIN, FILTER_DEFAULTS.PRICE.MAX);
                priceMax = this.clamp(priceMax, FILTER_DEFAULTS.PRICE.MIN, FILTER_DEFAULTS.PRICE.MAX);
                
                // Ensure min doesn't exceed max
                if (priceMin > priceMax) {
                    [priceMin, priceMax] = [priceMax, priceMin];
                }

                // Update the UI with validated values
                document.getElementById('ageRangeMin').value = ageMin;
                document.getElementById('ageRangeMax').value = ageMax;
                document.getElementById('priceRangeMin').value = priceMin;
                document.getElementById('priceRangeMax').value = priceMax;

                // Update current filters
                this.currentFilters = {
                    age: { min: ageMin, max: ageMax },
                    price: { min: priceMin, max: priceMax }
                };
            }

            clamp(value, min, max) {
                return Math.min(Math.max(value, min), max);
            }

            applyFiltersAndSearch() {
                try {
                    // Start with all books
                    let results = [...this.allBooks];

                    // Apply search if there's a search term
                    if (this.searchTerm) {
                        results = this.searchBooks(results, this.searchTerm);
                    }

                    // Apply filters
                    results = this.filterBooks(results);

                    // Update filtered books
                    this.filteredBooks = results;

                    // Trigger display update
                    this.updateDisplay();
                    
                    // Update UI to show number of results
                    this.updateResultsCount(results.length);
                } catch (error) {
                    console.error('Error in search/filter:', error);
                    this.showErrorMessage('An error occurred while filtering books.');
                }
            }

            searchBooks(books, term) {
                if (!term) return books;

                const searchTerms = term.split(' ').filter(t => t.length > 0);
                
                return books.filter(book => {
                    const searchableText = [
                        book['book name'] || '',
                        book['author'] || '',
                        book['isbn10'] || '',
                        book['isbn13'] || '',
                        book['description'] || ''
                    ].join(' ').toLowerCase();

                    return searchTerms.every(term => searchableText.includes(term));
                });
            }

            filterBooks(books) {
                return books.filter(book => {
                    const age = parseInt(book['age']) || 0;
                    const price = parseInt(book['price']) || 0;

                    return (
                        age >= this.currentFilters.age.min &&
                        age <= this.currentFilters.age.max &&
                        price >= this.currentFilters.price.min &&
                        price <= this.currentFilters.price.max
                    );
                });
            }

            updateDisplay() {
                // Implementation of your existing displayBooks function
                // But now called through this method
                displayBooks();
            }

            updateResultsCount(count) {
                const resultsCount = document.createElement('div');
                resultsCount.className = 'results-count mt-2 mb-3';
                resultsCount.textContent = `Found ${count} book${count !== 1 ? 's' : ''}`;
                
                const container = document.querySelector('.books-section .container');
                const existingCount = container.querySelector('.results-count');
                if (existingCount) {
                    container.removeChild(existingCount);
                }
                container.insertBefore(resultsCount, document.getElementById('booksContainer'));
            }

            showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = message;
                
                const container = document.querySelector('.books-section .container');
                const existingError = container.querySelector('.alert-danger');
                if (existingError) {
                    container.removeChild(existingError);
                }
                container.insertBefore(errorDiv, document.getElementById('booksContainer'));
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize the search and filter functionality
        const bookSearchFilter = new BookSearchAndFilter();
    </script>
</body>
</html>
